---
phase: 01-core-transformation-basic-ui
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/controller.py
  - src/main.py
autonomous: false

must_haves:
  truths:
    - "User can launch application and see the UI"
    - "User can select an IFC file through file dialog"
    - "User can select output directory through directory dialog"
    - "User can enter offset and rotation values"
    - "User can toggle rotate-first checkbox"
    - "Process button triggers transformation with visual feedback"
    - "Error messages display for invalid inputs"
    - "Success message displays after transformation completes"
  artifacts:
    - path: "src/controller.py"
      provides: "Event handling and threading"
      exports: ["TransformController"]
    - path: "src/main.py"
      provides: "Application entry point"
      contains: "mainloop"
  key_links:
    - from: "src/controller.py"
      to: "src/model.py"
      via: "model.transform_file() call"
      pattern: "model\\.transform_file"
    - from: "src/controller.py"
      to: "src/view.py"
      via: "view method calls"
      pattern: "view\\.(show_error|show_success|set_processing)"
    - from: "src/controller.py"
      to: "src/utils/validation.py"
      via: "validation function calls"
      pattern: "validate_input_file|validate_output_directory"
    - from: "src/main.py"
      to: "MVC components"
      via: "imports and instantiation"
      pattern: "IFCTransformModel|TransformView|TransformController"
---

<objective>
Wire the MVC components together and create a working application.

Purpose: Connect the model, view, and validation layers through a controller that handles user events, runs transformations in background threads, and provides user feedback. This completes the core transformation feature.

Output: Fully functional IFC transformation application with working Process button.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-transformation-basic-ui/01-RESEARCH.md
@.planning/phases/01-core-transformation-basic-ui/01-01-SUMMARY.md
@.planning/phases/01-core-transformation-basic-ui/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create controller with threading and event handling</name>
  <files>
    src/controller.py
  </files>
  <action>
    Create the controller that wires model, view, and validation together:

    1. Create `src/controller.py` with class `TransformController`:

    2. **__init__(self, model, view):**
       - Store model and view references
       - Create result queue: self.result_queue = queue.Queue()
       - Set controller on view: view.set_controller(self)
       - Start queue polling: self._start_queue_polling()

    3. **_start_queue_polling(self):**
       - Call self.view.root.after(100, self._check_queue)

    4. **_check_queue(self):**
       - Try to get from result_queue with get_nowait()
       - If result found:
         - Call view.set_processing(False)
         - If result['success']: view.show_success(result['message'])
         - Else: view.show_error(result['message'])
       - Except queue.Empty: pass
       - Finally: self.view.root.after(100, self._check_queue) to continue polling

    5. **on_process_clicked(self):**
       - Get form values: values = self.view.get_values()

       - Validate inputs (wrap in try/except ValueError):
         - validate_input_file(values['input_file'])
         - validate_output_directory(values['output_dir'])
         - Build output_path = build_output_path(values['input_file'], values['output_dir'])

       - If validation fails: view.show_error(str(e)) and return

       - Set UI to processing state: view.set_processing(True)

       - Start background thread:
         ```python
         thread = threading.Thread(
             target=self._run_transformation,
             args=(values, output_path)
         )
         thread.daemon = True
         thread.start()
         ```

    6. **_run_transformation(self, values, output_path):**
       - This runs in background thread - NO direct UI calls
       - try:
         - Determine rotation value: rotation_z = values['rotation'] if values['rotation'] != 0 else None
         - Call model.transform_file(
             input_path=values['input_file'],
             output_path=str(output_path),
             x=values['x'],
             y=values['y'],
             z=values['z'],
             should_rotate_first=values['rotate_first'],
             rotation_z=rotation_z
           )
         - Put success result: self.result_queue.put({'success': True, 'message': f'Transformation complete!\nOutput: {output_path}'})
       - except ValueError as e:
         - self.result_queue.put({'success': False, 'message': str(e)})
       - except Exception as e:
         - self.result_queue.put({'success': False, 'message': f'Transformation failed: {e}'})

    7. **Imports:**
       - import threading
       - import queue
       - from src.utils.validation import validate_input_file, validate_output_directory, build_output_path
  </action>
  <verify>
    ```bash
    cd /Users/liamwilks/code/ifc_translate_tool && source .venv/bin/activate && python -c "
    from src.controller import TransformController
    from src.model import IFCTransformModel
    import tkinter as tk

    # Mock view for testing
    class MockView:
        def __init__(self, root):
            self.root = root
            self.controller = None
            self.processing = False
            self.last_error = None
            self.last_success = None

        def set_controller(self, c):
            self.controller = c

        def get_values(self):
            return {
                'input_file': '',
                'output_dir': '',
                'x': 0.0, 'y': 0.0, 'z': 0.0,
                'rotation': 0.0,
                'rotate_first': True
            }

        def set_processing(self, p):
            self.processing = p

        def show_error(self, msg):
            self.last_error = msg

        def show_success(self, msg):
            self.last_success = msg

    root = tk.Tk()
    root.withdraw()

    model = IFCTransformModel()
    view = MockView(root)
    controller = TransformController(model, view)

    print('Controller instantiated: OK')
    assert view.controller is controller, 'Controller not set on view'
    print('Controller linked to view: OK')

    # Test validation error handling
    controller.on_process_clicked()
    assert view.last_error is not None, 'Should have shown error for empty input'
    assert 'No file selected' in view.last_error
    print('Validation error handling: OK')

    root.destroy()
    print('All controller tests passed')
    "
    ```
  </verify>
  <done>
    - src/controller.py exists with TransformController class
    - Controller links model and view
    - on_process_clicked validates inputs before processing
    - Transformation runs in background thread
    - Results communicated via queue for thread-safe UI updates
    - Error handling shows user-friendly messages
    - All controller tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire main.py and create working application</name>
  <files>
    src/main.py
  </files>
  <action>
    Update main.py to create and wire all MVC components:

    1. Update `src/main.py`:

    ```python
    import tkinter as tk
    from src.model import IFCTransformModel
    from src.view import TransformView
    from src.controller import TransformController

    def main():
        # Create root window
        root = tk.Tk()

        # Create MVC components
        model = IFCTransformModel()
        view = TransformView(root)
        controller = TransformController(model, view)

        # Start the application
        root.mainloop()

    if __name__ == "__main__":
        main()
    ```

    2. Verify the application launches correctly by running it
  </action>
  <verify>
    ```bash
    cd /Users/liamwilks/code/ifc_translate_tool && source .venv/bin/activate && timeout 3 python src/main.py || true
    ```
    The application should launch (will timeout after 3 seconds since it's a GUI).
    No import errors or crashes should occur.

    Also verify imports work:
    ```bash
    python -c "from src.main import main; print('Main import OK')"
    ```
  </verify>
  <done>
    - src/main.py creates MVC components
    - Application launches without import errors
    - All components properly wired
    - Ready for end-to-end testing
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete application works</name>
  <what-built>
    Complete IFC transformation application with:
    - File selection dialog for IFC files
    - Output directory selection
    - X/Y/Z offset input fields
    - Rotation angle input field
    - "Rotate First" checkbox
    - Process button with background processing
    - Error messages for invalid inputs
    - Success messages after transformation
  </what-built>
  <how-to-verify>
    1. Launch the application:
       ```bash
       cd /Users/liamwilks/code/ifc_translate_tool && source .venv/bin/activate && python src/main.py
       ```

    2. Verify UI elements:
       - Window titled "IFC Translate Tool" appears
       - Input file field with Browse button
       - Output directory field with Browse button
       - X, Y, Z offset fields (default 0)
       - Rotation field (default 0)
       - "Rotate First" checkbox (default checked)
       - Process button
       - Status area

    3. Test validation:
       - Click Process with no file selected
       - Expected: Error message "No file selected"

    4. Test with a real IFC file (if available):
       - Select an IFC file
       - Select output directory
       - Enter some offset values (e.g., X=100, Y=50, Z=0)
       - Click Process
       - Expected: "Processing..." status, then success message with output path
       - Verify output file exists in output directory with same filename

    5. Test UI responsiveness:
       - During processing, UI should remain responsive (not frozen)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Complete verification checklist:

1. Application launches: `python src/main.py` opens GUI window
2. All form fields present and functional
3. Validation errors display for invalid inputs
4. Transformation works with real IFC file
5. UI remains responsive during processing
6. Output file appears in correct directory with correct name
</verification>

<success_criteria>
Phase 1 requirements met:
- TRAN-01: X/Y/Z offsets applied via IfcPatch OffsetObjectPlacements
- TRAN-02: Rotation values applied
- TRAN-03: "Rotate First" toggle controls operation order
- FILE-01: Single IFC file selection working
- FILE-03: Output directory configurable
- FILE-04: Output files retain original filename

Success criteria from roadmap:
1. User can select IFC file and output directory through UI - WORKING
2. User can enter X/Y/Z offset and rotation values - WORKING
3. User can toggle "Rotate First" - WORKING
4. Process button creates transformed file - WORKING
5. Error messages display for failures - WORKING
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-transformation-basic-ui/01-03-SUMMARY.md`
</output>

---
phase: 04-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements-dev.txt
  - ifc_translate.spec
  - .gitignore
  - installer/setup.iss
autonomous: true

must_haves:
  truths:
    - "PyInstaller spec file configures ifcopenshell and ifcpatch collection correctly"
    - "Build artifacts (build/, dist/, installer output) are gitignored"
    - "Inno Setup script defines Start Menu and Desktop shortcuts"
    - "Installer script references correct dist folder structure"
  artifacts:
    - path: "requirements-dev.txt"
      provides: "Development dependencies including PyInstaller"
      contains: "pyinstaller"
    - path: "ifc_translate.spec"
      provides: "PyInstaller build configuration"
      contains: "collect_all"
    - path: "installer/setup.iss"
      provides: "Inno Setup installer script"
      contains: "IFC Translate Tool"
    - path: ".gitignore"
      provides: "Updated gitignore with build artifacts"
      contains: "installer/*.exe"
  key_links:
    - from: "ifc_translate.spec"
      to: "src/main.py"
      via: "Analysis entry point"
      pattern: "src/main.py"
    - from: "installer/setup.iss"
      to: "dist/IFC Translate Tool/"
      via: "Source files reference"
      pattern: "dist.*IFC Translate Tool"
---

<objective>
Create PyInstaller spec file and Inno Setup installer script for Windows distribution.

Purpose: Provide all configuration files needed to bundle the application as a standalone Windows executable with a professional installer. These files can be created on any platform but must be built on Windows.

Output:
- requirements-dev.txt with PyInstaller
- ifc_translate.spec configured for ifcopenshell/ifcpatch native libraries
- installer/setup.iss for Inno Setup
- Updated .gitignore
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-distribution/04-RESEARCH.md

@src/main.py
@requirements.txt
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create development requirements and update gitignore</name>
  <files>requirements-dev.txt, .gitignore</files>
  <action>
Create requirements-dev.txt with development dependencies:
- Include all production dependencies from requirements.txt (ifcopenshell==0.7.10, ifcpatch==0.7.10, platformdirs>=4.0.0)
- Add pyinstaller (latest version, no pin needed for build tool)
- Add pyinstaller-hooks-contrib (installed automatically but explicit is clearer)

Update .gitignore to add build artifact patterns:
- build/ (already present, keep it)
- dist/ (already present, keep it)
- Add: *.spec.bak (PyInstaller backup files)
- Add: installer/*.exe (compiled installer output)
- Add: installer/Output/ (Inno Setup default output directory)
  </action>
  <verify>
- `cat requirements-dev.txt` shows pyinstaller and all production deps
- `grep "installer" .gitignore` shows installer patterns
  </verify>
  <done>
- requirements-dev.txt exists with pyinstaller and production dependencies
- .gitignore updated with installer artifact patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PyInstaller spec file</name>
  <files>ifc_translate.spec</files>
  <action>
Create ifc_translate.spec in project root with:

1. Import collect_all from PyInstaller.utils.hooks

2. Collect ifcopenshell:
   - Use collect_all('ifcopenshell') to get datas, binaries, hiddenimports
   - This captures the native C++ wrapper (_ifcopenshell_wrapper.pyd) and dependent DLLs

3. Collect ifcpatch:
   - Use collect_all('ifcpatch') to get datas, binaries, hiddenimports
   - This captures the recipes directory needed for OffsetObjectPlacements

4. Collect platformdirs:
   - Use collect_all('platformdirs') for cross-platform directory handling

5. Configure Analysis:
   - Entry point: 'src/main.py'
   - Include collected datas, binaries, hiddenimports
   - No excludes needed

6. Configure EXE:
   - name='IFC Translate Tool'
   - console=False (GUI app, no console window)
   - upx=False (avoid DLL corruption - per research pitfall #3)
   - No icon (can be added later if client provides one)

7. Configure COLLECT (--onedir mode):
   - name='IFC Translate Tool'
   - strip=False, upx=False

Use --onedir mode (COLLECT) not --onefile because:
- Native extensions work more reliably
- Faster startup time
- Easier to debug if issues arise
  </action>
  <verify>
- `cat ifc_translate.spec` shows collect_all for ifcopenshell and ifcpatch
- Spec file has console=False and upx=False
- Analysis points to src/main.py
  </verify>
  <done>
- ifc_translate.spec exists with correct configuration
- Spec file uses collect_all for ifcopenshell, ifcpatch, platformdirs
- EXE configured for GUI mode (no console)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Inno Setup installer script</name>
  <files>installer/setup.iss</files>
  <action>
Create installer/setup.iss directory and file with:

[Setup] section:
- AppName=IFC Translate Tool
- AppVersion=1.0.0
- AppPublisher=(leave as placeholder or client name)
- DefaultDirName={autopf}\IFC Translate Tool
- DefaultGroupName=IFC Translate Tool
- OutputBaseFilename=IFC_Translate_Tool_Setup
- Compression=lzma
- SolidCompression=yes
- WizardStyle=modern
- UninstallDisplayIcon={app}\IFC Translate Tool.exe

[Languages] section:
- English as default

[Tasks] section:
- desktopicon task (unchecked by default per research pattern)

[Files] section:
- Source: "..\dist\IFC Translate Tool\*"
- DestDir: "{app}"
- Flags: ignoreversion recursesubdirs
(Note: relative path from installer/ to dist/)

[Icons] section:
- Start Menu shortcut: {group}\IFC Translate Tool
- Start Menu uninstall: {group}\Uninstall IFC Translate Tool
- Desktop shortcut (conditional on task): {commondesktop}\IFC Translate Tool

[Run] section:
- Launch after install option (nowait postinstall skipifsilent flags)

Add comment at top explaining:
- This script is compiled with Inno Setup 6.x on Windows
- Prerequisites: Run PyInstaller first to create dist folder
- Command: iscc setup.iss (from installer directory)
  </action>
  <verify>
- `ls installer/` shows setup.iss
- `grep "IFC Translate Tool" installer/setup.iss` shows app name
- `grep "desktopicon" installer/setup.iss` shows desktop shortcut task
  </verify>
  <done>
- installer/setup.iss exists with complete Inno Setup configuration
- Script includes Start Menu and Desktop shortcuts
- File references point to correct dist folder structure
  </done>
</task>

</tasks>

<verification>
All configuration files created:
- [ ] `cat requirements-dev.txt` includes pyinstaller
- [ ] `cat ifc_translate.spec` shows collect_all patterns
- [ ] `cat installer/setup.iss` shows Inno Setup structure
- [ ] `grep -E "installer|\.spec" .gitignore` shows new patterns
</verification>

<success_criteria>
1. requirements-dev.txt exists with pyinstaller and production dependencies
2. ifc_translate.spec exists with ifcopenshell/ifcpatch collection
3. installer/setup.iss exists with Start Menu and Desktop shortcuts
4. .gitignore updated for build artifacts
5. All files are valid syntax (spec is Python, iss is Inno Setup)
</success_criteria>

<output>
After completion, create `.planning/phases/04-distribution/04-01-SUMMARY.md`
</output>

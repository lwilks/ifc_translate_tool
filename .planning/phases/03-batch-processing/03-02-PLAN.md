---
phase: 03-batch-processing
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/controller.py
autonomous: false

must_haves:
  truths:
    - "User can select directory and process all IFC files with one click"
    - "User sees progress updates (current file and count) during batch processing"
    - "User can cancel batch processing and it stops before next file"
    - "Cancelled batch does not leave corrupted files"
    - "Failed files do not stop entire batch"
  artifacts:
    - path: "src/controller.py"
      provides: "Batch processing with cancellation and progress"
      contains: "threading.Event"
  key_links:
    - from: "src/controller.py"
      to: "find_ifc_files"
      via: "import and call in batch processing"
      pattern: "find_ifc_files"
    - from: "src/controller.py"
      to: "self.view.update_batch_progress"
      via: "queue message handling"
      pattern: "update_batch_progress"
    - from: "src/controller.py"
      to: "self.model.transform_file"
      via: "loop in _run_batch_transformation"
      pattern: "transform_file"
---

<objective>
Wire batch processing logic in controller with cancellation support, progress tracking, and error handling for multi-file transformation.

Purpose: Enable users to process entire directories of IFC files with visual progress and safe cancellation.
Output: Working batch processing that transforms all IFC files in a directory with the current transformation settings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-batch-processing/03-RESEARCH.md
@.planning/phases/03-batch-processing/03-01-SUMMARY.md

# Source files
@src/controller.py
@src/view.py
@src/utils/validation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch processing logic to TransformController</name>
  <files>src/controller.py</files>
  <action>
Modify TransformController to support batch processing:

1. **Update imports** at top of file:
   - Add `threading` import for `threading.Event` (threading module already imported)
   - Add `from src.utils.validation import validate_input_directory, find_ifc_files` to existing import line

2. **Add instance variables in __init__**:
   - `self.stop_event = threading.Event()` - for cancellation signaling
   - `self.batch_errors = []` - collect errors during batch

3. **Modify on_process_clicked** to handle batch mode:
   At the start of on_process_clicked, check batch mode:
   ```python
   if self.view.get_batch_mode():
       self._on_batch_process_clicked()
       return
   ```
   Rest of existing single-file logic remains unchanged.

4. **Add _on_batch_process_clicked method**:
   - Get values: `values = self.view.get_values()` (transformation params)
   - Get input directory: `input_dir = self.view.get_input_directory()`
   - Validate:
     - Call `validate_input_directory(input_dir)` - catch ValueError, show_error, return
     - Call `validate_output_directory(values['output_dir'])` - catch ValueError, show_error, return
   - Find files: `files = find_ifc_files(input_dir)`
   - Check empty: if `len(files) == 0`, show_error("No IFC files found in directory"), return
   - Reset state:
     - `self.stop_event.clear()`
     - `self.batch_errors = []`
     - `self.view.reset_cancel()`
   - Start progress: `self.view.start_batch_progress(len(files))`
   - Set UI to processing: `self.view.set_processing(True)`
   - Start thread:
     ```python
     thread = threading.Thread(
         target=self._run_batch_transformation,
         args=(files, values)
     )
     thread.daemon = True
     thread.start()
     ```

5. **Add _run_batch_transformation method**:
   ```python
   def _run_batch_transformation(self, files, values):
       """Run batch transformation in background thread."""
       output_dir = values['output_dir']
       rotation_z = values['rotation'] if values['rotation'] != 0 else None

       for i, input_file in enumerate(files):
           # Check cancellation before each file
           if self.stop_event.is_set():
               self.result_queue.put({
                   'type': 'batch_cancelled',
                   'processed': i,
                   'total': len(files)
               })
               return

           output_path = build_output_path(str(input_file), output_dir)

           try:
               self.model.transform_file(
                   input_path=str(input_file),
                   output_path=str(output_path),
                   x=values['x'],
                   y=values['y'],
                   z=values['z'],
                   should_rotate_first=values['rotate_first'],
                   rotation_z=rotation_z
               )
               # Report progress
               self.result_queue.put({
                   'type': 'batch_progress',
                   'current': i + 1,
                   'total': len(files),
                   'filename': input_file.name
               })
           except Exception as e:
               # Log error but continue batch
               self.batch_errors.append((input_file.name, str(e)))
               self.result_queue.put({
                   'type': 'batch_error',
                   'filename': input_file.name,
                   'error': str(e),
                   'current': i + 1,
                   'total': len(files)
               })

       # Batch complete
       self.result_queue.put({
           'type': 'batch_complete',
           'total': len(files),
           'errors': len(self.batch_errors)
       })
   ```

6. **Update _check_queue to handle batch messages**:
   Add handling for new message types before the existing try block's empty check:
   ```python
   # Inside try block, after getting result:
   msg_type = result.get('type')

   if msg_type == 'batch_progress':
       self.view.update_batch_progress(
           result['current'],
           result['total'],
           result['filename']
       )

   elif msg_type == 'batch_error':
       # Update progress even on error (batch continues)
       self.view.update_batch_progress(
           result['current'],
           result['total'],
           f"ERROR: {result['filename']}"
       )

   elif msg_type == 'batch_cancelled':
       self.view.set_processing(False)
       self.view.end_batch_progress()
       self.view.show_status(f"Cancelled after {result['processed']}/{result['total']} files")

   elif msg_type == 'batch_complete':
       self.view.set_processing(False)
       self.view.end_batch_progress()
       self._show_batch_summary(result['total'], result['errors'])

   elif result.get('success') is not None:
       # Existing single-file handling
       self.view.set_processing(False)
       if result['success']:
           self.view.show_success(result['message'])
       else:
           self.view.show_error(result['message'])
   ```

7. **Add _show_batch_summary method**:
   ```python
   def _show_batch_summary(self, total, error_count):
       """Show batch processing summary dialog."""
       success_count = total - error_count

       if error_count == 0:
           self.view.show_success(
               f"Batch complete!\n\n"
               f"Successfully processed {success_count} files."
           )
       else:
           # Build error details
           error_details = "\n".join(
               f"  - {name}: {error}"
               for name, error in self.batch_errors[:5]  # Show first 5
           )
           more = f"\n  ... and {error_count - 5} more" if error_count > 5 else ""

           self.view.show_error(
               f"Batch complete with errors.\n\n"
               f"Succeeded: {success_count}\n"
               f"Failed: {error_count}\n\n"
               f"Errors:\n{error_details}{more}"
           )
   ```

8. **Add on_cancel_clicked method** (called by view):
   ```python
   def on_cancel_clicked(self):
       """Handle cancel button click during batch processing."""
       self.stop_event.set()
       self.view.show_status("Cancelling...")
   ```

9. **Update view's _on_cancel_clicked** to call controller:
   The view's method should call `self.controller.on_cancel_clicked()` if controller exists.
   (This is a minor update to view.py - include it here since it's wiring)

**Important:** In view.py, update `_on_cancel_clicked`:
```python
def _on_cancel_clicked(self):
    """Handle cancel button click."""
    self.cancel_requested = True
    self.cancel_button.config(state=tk.DISABLED)
    if self.controller is not None:
        self.controller.on_cancel_clicked()
```
  </action>
  <verify>
Test batch processing end-to-end:
1. Create test directory with 2-3 small IFC files
2. Launch app, switch to Batch mode
3. Select input directory and output directory
4. Click Process - verify progress updates
5. Verify all files transformed in output directory
6. Test cancellation with larger batch
```bash
cd /Users/liamwilks/code/ifc_translate_tool && source .venv/bin/activate && python src/main.py
```
  </verify>
  <done>
- Batch mode processes all IFC files in directory
- Progress bar and status update for each file
- Errors are collected and batch continues
- Cancellation stops before next file (no corruption)
- Summary dialog shows success/failure counts
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete batch processing workflow with progress tracking and cancellation support</what-built>
  <how-to-verify>
1. Launch application: `python src/main.py`
2. **Test mode toggle:**
   - Click "Batch (Directory)" radio button
   - Verify: File input hides, directory input shows, progress section appears

3. **Test batch processing:**
   - Select an input directory containing 2+ IFC files
   - Select an output directory
   - Set any transformation values (e.g., X=10)
   - Click "Process"
   - Verify: Progress bar fills, status shows current file and count
   - Verify: All transformed files appear in output directory

4. **Test cancellation:**
   - Start a batch with several files
   - Click "Cancel" while processing
   - Verify: Processing stops, status shows "Cancelled after X/Y files"
   - Verify: Files processed before cancel are complete (not corrupted)

5. **Test error handling:**
   - Include a non-IFC file renamed to .ifc in input directory
   - Run batch
   - Verify: Batch continues past error, summary shows failure count

6. **Test empty directory:**
   - Select empty directory as input
   - Click Process
   - Verify: Error message "No IFC files found in directory"

7. **Test single file mode still works:**
   - Switch back to "Single File" mode
   - Process single file as before
   - Verify: Original behavior unchanged
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. Application launches without errors
2. Batch mode processes entire directory with progress updates
3. Cancellation works cleanly between files
4. Error handling doesn't stop batch
5. Single file mode unchanged (regression test)
</verification>

<success_criteria>
- User can select input directory and process all IFC files with one click
- Progress bar and status show current file and completion percentage
- Cancel button stops processing before next file without corrupting files
- Failed files are logged but don't stop batch
- Summary dialog shows success/failure counts
- Single file mode continues to work as before
</success_criteria>

<output>
After completion, create `.planning/phases/03-batch-processing/03-02-SUMMARY.md`
</output>

---
phase: 03-batch-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/validation.py
  - src/view.py
autonomous: true

must_haves:
  truths:
    - "User can select an input directory via browse dialog"
    - "User can toggle between single file and batch mode"
    - "Directory browse shows folder selection dialog"
    - "Progress bar is visible in batch mode"
    - "Cancel button is visible in batch mode"
  artifacts:
    - path: "src/utils/validation.py"
      provides: "Directory validation and IFC file discovery"
      contains: "find_ifc_files"
    - path: "src/view.py"
      provides: "Batch mode UI components"
      contains: "ttk.Progressbar"
  key_links:
    - from: "src/view.py"
      to: "filedialog.askdirectory"
      via: "directory browse button callback"
      pattern: "askdirectory"
---

<objective>
Add batch processing validation utilities and UI components to support directory-based multi-file processing.

Purpose: Enable users to select a directory of IFC files and see progress/cancel controls for batch operations.
Output: Validation utilities for directory handling and view components for batch mode UI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-batch-processing/03-RESEARCH.md

# Source files to modify
@src/utils/validation.py
@src/view.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add directory validation and IFC file discovery utilities</name>
  <files>src/utils/validation.py</files>
  <action>
Add two new functions to validation.py:

1. `validate_input_directory(dir_path: str) -> Path`:
   - Return ValueError if dir_path is empty ("No input directory selected")
   - Return ValueError if path doesn't exist ("Directory does not exist: {path}")
   - Return ValueError if path is not a directory ("Path is not a directory: {path}")
   - Return ValueError if not readable (os.R_OK check: "No read permission for directory: {path}")
   - Return Path object on success

2. `find_ifc_files(directory_path: str) -> list[Path]`:
   - Use `Path(directory_path).glob('*.ifc')` for file discovery
   - Sort results with `sorted()` for consistent ordering across platforms
   - Filter with `f.is_file()` to exclude any directories matching pattern
   - Return empty list if no IFC files found (caller handles the error message)
   - Case-insensitive: also glob for '*.IFC' and combine results

Follow existing validation.py patterns (docstrings, imports, error message style).
  </action>
  <verify>
Run Python to test functions:
```python
from src.utils.validation import validate_input_directory, find_ifc_files
# Test validation with non-existent directory
try:
    validate_input_directory("/nonexistent")
except ValueError as e:
    print(f"Expected error: {e}")
# Test find_ifc_files returns list
result = find_ifc_files(".")
print(f"Type: {type(result)}, is list: {isinstance(result, list)}")
```
  </verify>
  <done>
- validate_input_directory raises ValueError for invalid paths, returns Path for valid
- find_ifc_files returns sorted list[Path] of .ifc files (case-insensitive)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add batch mode UI components to TransformView</name>
  <files>src/view.py</files>
  <action>
Modify TransformView to support batch mode UI:

1. **Add new instance variables in __init__**:
   - `self.batch_mode_var = tk.BooleanVar(value=False)` - toggle for batch vs single mode
   - `self.input_dir_var = tk.StringVar()` - input directory path
   - `self.cancel_requested = False` - flag for cancellation state

2. **Add batch mode toggle** (after presets, before file selection):
   - Create LabelFrame "Processing Mode" with two radiobuttons:
     - "Single File" (value=False)
     - "Batch (Directory)" (value=True)
   - Both bound to `batch_mode_var`
   - Add `command=self._on_mode_changed` to toggle visibility

3. **Add input directory row** (after input file row):
   - Same layout pattern as input file: Label + Entry + Browse button
   - Label: "Input Directory:", width=15, anchor="w"
   - Entry: textvariable=input_dir_var, width=35
   - Button: "Browse...", command=self._select_input_dir
   - Initially hidden (pack_forget)

4. **Add progress section** (after process button):
   - Create LabelFrame "Progress" containing:
     - `ttk.Progressbar` (orient='horizontal', length=400, mode='determinate')
       Store as `self.progress_bar`
     - Status label with `self.batch_status_var = tk.StringVar(value="")`
       Shows current file name: "Processing: filename.ifc (3/10)"
   - Initially hidden (pack_forget entire frame)
   - Store frame reference as `self.progress_frame`

5. **Add Cancel button** (next to Process button in button_frame):
   - Text: "Cancel"
   - command: `self._on_cancel_clicked`
   - Store as `self.cancel_button`
   - Initially disabled and hidden

6. **Add helper methods**:
   - `_select_input_dir()`: Use filedialog.askdirectory(), set input_dir_var
   - `_on_mode_changed()`: Toggle visibility of single file vs directory inputs
     - When batch=True: hide input file row, show input directory row, show progress frame
     - When batch=False: show input file row, hide input directory row, hide progress frame
   - `_on_cancel_clicked()`: Set cancel_requested=True, disable cancel button
   - `get_batch_mode() -> bool`: Return batch_mode_var.get()
   - `get_input_directory() -> str`: Return input_dir_var.get()
   - `start_batch_progress(total: int)`: Set progress_bar maximum, value=0, show progress frame
   - `update_batch_progress(current: int, total: int, filename: str)`: Update progress_bar value and batch_status_var
   - `end_batch_progress()`: Hide progress frame, reset progress_bar
   - `is_cancel_requested() -> bool`: Return cancel_requested
   - `reset_cancel()`: Set cancel_requested=False, enable cancel button

Store references to rows that need show/hide:
- `self.input_file_frame` - the frame containing input file controls
- `self.input_dir_frame` - the frame containing input directory controls

Increase window height from 580 to 680 to accommodate new UI elements.
  </action>
  <verify>
Run the application and verify:
1. Mode radio buttons appear and toggle
2. Switching to Batch mode shows directory input, hides file input
3. Progress bar and cancel button are visible in batch mode
4. Browse button opens folder selection dialog
```bash
cd /Users/liamwilks/code/ifc_translate_tool && source .venv/bin/activate && python src/main.py
```
  </verify>
  <done>
- Batch/Single mode toggle works and switches visible inputs
- Progress bar and cancel button appear in batch mode
- Directory browse opens folder selection dialog
- Window accommodates all new UI elements
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `python -c "from src.utils.validation import validate_input_directory, find_ifc_files; print('Imports OK')"` succeeds
2. Application launches without errors: `python src/main.py`
3. Mode toggle switches between single file and batch directory UI
4. Progress bar widget exists and is configurable
</verification>

<success_criteria>
- validate_input_directory and find_ifc_files functions exist and work correctly
- TransformView has batch mode toggle, directory input, progress bar, and cancel button
- UI elements show/hide correctly based on mode selection
- No regressions in existing single-file functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-batch-processing/03-01-SUMMARY.md`
</output>

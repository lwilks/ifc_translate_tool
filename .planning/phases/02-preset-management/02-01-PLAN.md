---
phase: 02-preset-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - src/presets_model.py
autonomous: true

must_haves:
  truths:
    - "PresetsModel can save a preset to JSON file"
    - "PresetsModel can load all presets from JSON file"
    - "PresetsModel can delete a preset by name"
    - "PresetsModel can track last-used preset name"
    - "Presets persist in cross-platform user data directory"
  artifacts:
    - path: "src/presets_model.py"
      provides: "Preset persistence operations"
      min_lines: 60
      contains: "class PresetsModel"
    - path: "requirements.txt"
      provides: "platformdirs dependency"
      contains: "platformdirs"
  key_links:
    - from: "src/presets_model.py"
      to: "platformdirs.user_data_dir"
      via: "import and call"
      pattern: "user_data_dir"
    - from: "src/presets_model.py"
      to: "json.dump"
      via: "atomic write"
      pattern: "_atomic_write_json"
---

<objective>
Create the PresetsModel class for preset persistence operations using JSON storage in cross-platform user data directory.

Purpose: Provides the data layer for all preset operations (save, load, delete, list). This model follows the existing MVC pattern and enables the UI to persist transformation settings.

Output: `src/presets_model.py` with PresetsModel class, updated `requirements.txt` with platformdirs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-preset-management/02-RESEARCH.md
@src/model.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add platformdirs dependency</name>
  <files>requirements.txt</files>
  <action>
Add platformdirs to requirements.txt for cross-platform user data directory support.

Add line:
```
platformdirs>=4.0.0
```

After updating requirements.txt, install the dependency:
```bash
pip install -r requirements.txt
```

Verify installation works by testing import:
```bash
python -c "from platformdirs import user_data_dir; print(user_data_dir('IFCTranslateTool'))"
```
  </action>
  <verify>
`pip install -r requirements.txt` succeeds.
`python -c "from platformdirs import user_data_dir; print(user_data_dir('IFCTranslateTool'))"` prints a valid path.
  </verify>
  <done>platformdirs is installed and importable, requirements.txt updated.</done>
</task>

<task type="auto">
  <name>Task 2: Create PresetsModel class</name>
  <files>src/presets_model.py</files>
  <action>
Create `src/presets_model.py` with PresetsModel class following the MVC pattern established in Phase 1.

The class must implement:

1. **__init__(app_name, app_author)**: Initialize with cross-platform data directory using platformdirs.user_data_dir(). Create directory if it doesn't exist. Set up paths for presets.json and config.json.

2. **load_presets() -> dict**: Load all presets from presets.json. Return empty dict if file doesn't exist. Handle JSONDecodeError gracefully by returning empty dict (don't crash on corrupted file).

3. **save_preset(name: str, preset_data: dict)**: Save a single preset. Load existing presets, add/update the new one, write back using atomic write. Preset data structure matches view.get_values() output minus input_file and output_dir:
   ```python
   {
       "x": float,
       "y": float,
       "z": float,
       "rotation": float,
       "rotate_first": bool
   }
   ```

4. **delete_preset(name: str)**: Delete a preset by name. Load presets, remove if exists, write back atomically.

5. **list_presets() -> list[str]**: Return sorted list of preset names.

6. **save_last_used(preset_name: str)**: Save the last used preset name to config.json.

7. **get_last_used() -> str | None**: Get the last used preset name from config.json. Return None if not set or file doesn't exist.

8. **_atomic_write_json(filepath: Path, data: dict)**: Private method for atomic JSON writes. Write to .tmp file first, then use Path.replace() for atomic rename. Always use encoding='utf-8' and ensure_ascii=False.

Follow research patterns exactly:
- Use pathlib.Path for all file operations
- Use platformdirs.user_data_dir("IFCTranslateTool", "IFCTranslateTool") for data directory
- Atomic writes via temp file + replace
- encoding='utf-8' on all file operations
- Handle missing files gracefully (return empty dict/None, don't raise)
  </action>
  <verify>
Create a test script and run it:
```bash
python -c "
from src.presets_model import PresetsModel
pm = PresetsModel()
print('Data dir:', pm.data_dir)

# Test save
pm.save_preset('Test Preset', {'x': 10.0, 'y': 20.0, 'z': 0.0, 'rotation': 45.0, 'rotate_first': True})
print('After save:', pm.list_presets())

# Test load
presets = pm.load_presets()
print('Loaded:', presets.get('Test Preset'))

# Test last used
pm.save_last_used('Test Preset')
print('Last used:', pm.get_last_used())

# Test delete
pm.delete_preset('Test Preset')
print('After delete:', pm.list_presets())
"
```
All operations should succeed without errors.
  </verify>
  <done>
PresetsModel can save, load, list, and delete presets. Last-used preset tracking works. Atomic writes prevent corruption. Data stored in platform-appropriate directory.
  </done>
</task>

</tasks>

<verification>
1. `pip install -r requirements.txt` succeeds
2. `python -c "from src.presets_model import PresetsModel; pm = PresetsModel(); print(pm.data_dir)"` prints valid path
3. Save/load/delete/list operations work as verified in Task 2
4. Presets persist to disk (check file exists in data_dir)
5. Application still starts: `python src/main.py` launches UI without errors
</verification>

<success_criteria>
- PresetsModel class exists with all required methods
- platformdirs dependency installed
- Preset save creates JSON file in user data directory
- Preset load reads from JSON file correctly
- Delete removes preset from file
- Last-used tracking works
- Atomic writes implemented (temp file + replace pattern)
- Application still works after changes
</success_criteria>

<output>
After completion, create `.planning/phases/02-preset-management/02-01-SUMMARY.md`
</output>

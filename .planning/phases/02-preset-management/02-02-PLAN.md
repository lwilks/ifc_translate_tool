---
phase: 02-preset-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/view.py
  - src/controller.py
  - src/main.py
autonomous: false

must_haves:
  truths:
    - "User can save current transformation values as a named preset"
    - "User can select a preset from dropdown and all form fields populate automatically"
    - "User can delete unwanted presets from the application"
    - "User reopens application and sees the last used preset already loaded"
  artifacts:
    - path: "src/view.py"
      provides: "Preset UI components"
      contains: "preset_combo"
    - path: "src/controller.py"
      provides: "Preset operation handlers"
      contains: "on_save_preset"
    - path: "src/main.py"
      provides: "PresetsModel initialization"
      contains: "PresetsModel"
  key_links:
    - from: "src/view.py"
      to: "controller.on_save_preset"
      via: "button command"
      pattern: "on_save_preset"
    - from: "src/view.py"
      to: "controller.on_preset_selected"
      via: "combobox bind"
      pattern: "ComboboxSelected"
    - from: "src/controller.py"
      to: "presets_model.save_preset"
      via: "method call"
      pattern: "self.presets_model.save_preset"
    - from: "src/main.py"
      to: "controller.load_last_preset"
      via: "startup call"
      pattern: "load_last_preset"
---

<objective>
Add preset management UI to the view and wire all preset operations through the controller, including auto-loading the last used preset on startup.

Purpose: Completes the preset management feature by connecting the PresetsModel (from 02-01) to the UI, allowing users to save, load, and delete presets through the application interface.

Output: Updated `src/view.py` with preset UI, updated `src/controller.py` with preset handlers, updated `src/main.py` with PresetsModel integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-preset-management/02-RESEARCH.md
@.planning/phases/02-preset-management/02-01-SUMMARY.md
@src/view.py
@src/controller.py
@src/main.py
@src/presets_model.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preset UI to TransformView</name>
  <files>src/view.py</files>
  <action>
Modify `src/view.py` to add preset management UI components.

1. **Add ttk import** at top of file:
   ```python
   from tkinter import ttk
   ```

2. **Add preset UI section** in `_build_ui()` method, BEFORE the file selection section (so presets appear at top of the form):
   ```python
   # Preset management section
   preset_frame = tk.LabelFrame(main_frame, text="Presets", padx=10, pady=10)
   preset_frame.pack(fill=tk.X, pady=5)

   # Row with combobox and buttons
   preset_row = tk.Frame(preset_frame)
   preset_row.pack(fill=tk.X)

   # Preset dropdown (readonly to prevent typing)
   self.preset_combo = ttk.Combobox(preset_row, state='readonly', width=25)
   self.preset_combo.pack(side=tk.LEFT, padx=(0, 10))
   self.preset_combo.bind('<<ComboboxSelected>>', self._on_preset_selected)

   # Save button
   self.save_preset_button = tk.Button(preset_row, text="Save", command=self._on_save_preset_clicked)
   self.save_preset_button.pack(side=tk.LEFT, padx=2)

   # Delete button
   self.delete_preset_button = tk.Button(preset_row, text="Delete", command=self._on_delete_preset_clicked)
   self.delete_preset_button.pack(side=tk.LEFT, padx=2)
   ```

3. **Add event handler methods** to TransformView class:
   ```python
   def _on_preset_selected(self, event):
       """Handle preset selection from dropdown."""
       if self.controller is not None:
           self.controller.on_preset_selected()

   def _on_save_preset_clicked(self):
       """Handle Save preset button click."""
       if self.controller is not None:
           self.controller.on_save_preset()

   def _on_delete_preset_clicked(self):
       """Handle Delete preset button click."""
       if self.controller is not None:
           self.controller.on_delete_preset()
   ```

4. **Add view methods for controller to call**:
   ```python
   def update_preset_list(self, preset_names: list):
       """Update the preset dropdown with available presets."""
       self.preset_combo['values'] = preset_names
       # Disable delete button if no presets
       if preset_names:
           self.delete_preset_button.config(state=tk.NORMAL)
       else:
           self.delete_preset_button.config(state=tk.DISABLED)

   def get_selected_preset(self) -> str:
       """Get the currently selected preset name."""
       return self.preset_combo.get()

   def set_selected_preset(self, preset_name: str):
       """Set the selected preset in the dropdown."""
       self.preset_combo.set(preset_name)

   def set_values(self, values: dict):
       """Set form field values from a dictionary (opposite of get_values)."""
       self.x_var.set(str(values.get('x', 0)))
       self.y_var.set(str(values.get('y', 0)))
       self.z_var.set(str(values.get('z', 0)))
       self.rotation_var.set(str(values.get('rotation', 0)))
       self.rotate_first_var.set(values.get('rotate_first', True))

   def ask_preset_name(self) -> str | None:
       """Show dialog to get preset name from user. Returns None if cancelled."""
       from tkinter import simpledialog
       name = simpledialog.askstring(
           "Save Preset",
           "Enter preset name:",
           parent=self.root
       )
       return name.strip() if name else None

   def confirm_delete(self, preset_name: str) -> bool:
       """Show confirmation dialog for preset deletion."""
       return messagebox.askyesno(
           "Delete Preset",
           f"Delete preset '{preset_name}'?"
       )

   def confirm_overwrite(self, preset_name: str) -> bool:
       """Show confirmation dialog for preset overwrite."""
       return messagebox.askyesno(
           "Overwrite Preset",
           f"Preset '{preset_name}' already exists. Overwrite?"
       )
   ```

Note: The preset combobox should appear BEFORE the input file selection in the UI flow.
  </action>
  <verify>
`python src/main.py` launches and shows:
- Preset section with dropdown at top
- Save and Delete buttons next to dropdown
- Delete button is disabled (no presets yet)
- UI elements are visible and don't crash on click
  </verify>
  <done>Preset UI components added to view with all required methods for controller interaction.</done>
</task>

<task type="auto">
  <name>Task 2: Wire preset operations in controller and main.py</name>
  <files>src/controller.py, src/main.py</files>
  <action>
**Part A: Update src/controller.py**

1. **Update __init__ to accept presets_model**:
   ```python
   def __init__(self, model, view, presets_model):
       """
       Initialize controller with model, view, and presets model.

       Args:
           model: IFCTransformModel instance
           view: TransformView instance
           presets_model: PresetsModel instance
       """
       self.model = model
       self.view = view
       self.presets_model = presets_model
       self.result_queue = queue.Queue()

       # Wire controller to view
       view.set_controller(self)

       # Start queue polling for background thread results
       self._start_queue_polling()

       # Load preset list and auto-load last used
       self._refresh_preset_list()
       self.load_last_preset()
   ```

2. **Add preset operation methods**:
   ```python
   def _refresh_preset_list(self):
       """Refresh the preset dropdown with current presets."""
       presets = self.presets_model.list_presets()
       self.view.update_preset_list(presets)

   def on_preset_selected(self):
       """Handle preset selection from dropdown."""
       preset_name = self.view.get_selected_preset()
       if not preset_name:
           return

       presets = self.presets_model.load_presets()
       if preset_name in presets:
           self.view.set_values(presets[preset_name])
           self.presets_model.save_last_used(preset_name)

   def on_save_preset(self):
       """Handle save preset button click."""
       # Get preset name from user
       preset_name = self.view.ask_preset_name()
       if not preset_name:
           return

       # Check for overwrite
       existing_presets = self.presets_model.list_presets()
       if preset_name in existing_presets:
           if not self.view.confirm_overwrite(preset_name):
               return

       # Get current form values (exclude file paths)
       values = self.view.get_values()
       preset_data = {
           'x': values['x'],
           'y': values['y'],
           'z': values['z'],
           'rotation': values['rotation'],
           'rotate_first': values['rotate_first']
       }

       # Save preset
       self.presets_model.save_preset(preset_name, preset_data)
       self.presets_model.save_last_used(preset_name)

       # Refresh UI
       self._refresh_preset_list()
       self.view.set_selected_preset(preset_name)
       self.view.show_status(f"Preset '{preset_name}' saved")

   def on_delete_preset(self):
       """Handle delete preset button click."""
       preset_name = self.view.get_selected_preset()
       if not preset_name:
           self.view.show_error("No preset selected")
           return

       if not self.view.confirm_delete(preset_name):
           return

       # Delete preset
       self.presets_model.delete_preset(preset_name)

       # Clear selection and refresh
       self.view.set_selected_preset('')
       self._refresh_preset_list()
       self.view.show_status(f"Preset '{preset_name}' deleted")

   def load_last_preset(self):
       """Load the last used preset on startup."""
       last_used = self.presets_model.get_last_used()
       if not last_used:
           return

       presets = self.presets_model.load_presets()
       if last_used in presets:
           self.view.set_selected_preset(last_used)
           self.view.set_values(presets[last_used])
   ```

**Part B: Update src/main.py**

1. **Add PresetsModel import**:
   ```python
   from src.presets_model import PresetsModel
   ```

2. **Create PresetsModel and pass to controller** in main():
   ```python
   # Create presets model
   presets_model = PresetsModel()

   # Create controller (wires everything together)
   controller = TransformController(model, view, presets_model)
   ```

The main.py should now instantiate PresetsModel and pass it to TransformController.
  </action>
  <verify>
Run application and test all preset operations:
```bash
python src/main.py
```

Test sequence:
1. Enter values: X=10, Y=20, Z=5, Rotation=45
2. Click Save, enter "Test Preset", confirm
3. Verify dropdown shows "Test Preset"
4. Change values: X=0, Y=0, Z=0, Rotation=0
5. Select "Test Preset" from dropdown
6. Verify values restored: X=10, Y=20, Z=5, Rotation=45
7. Close and reopen application
8. Verify "Test Preset" is selected and values are loaded
9. Delete "Test Preset", confirm deletion
10. Verify dropdown is empty, delete button disabled
  </verify>
  <done>Controller handles all preset operations (save, load, delete, auto-load). Last-used preset loads on startup.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete preset management feature with save, load, delete, and auto-load functionality</what-built>
  <how-to-verify>
1. Run: `python src/main.py`
2. Create a preset:
   - Enter transformation values (any X, Y, Z, rotation)
   - Click "Save" button
   - Enter a preset name like "Site A Offset"
   - Click OK
   - Verify preset appears in dropdown
3. Test loading:
   - Change values in form to something different
   - Select your preset from dropdown
   - Verify all values are restored
4. Test auto-load:
   - Close the application
   - Reopen: `python src/main.py`
   - Verify the last used preset is automatically selected and loaded
5. Test delete:
   - Select a preset
   - Click "Delete"
   - Confirm deletion
   - Verify preset removed from dropdown
6. Verify existing transformation still works:
   - Select an IFC file
   - Set output directory
   - Click Process
   - Verify transformation completes successfully
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Application launches without errors
2. Preset dropdown visible at top of form
3. Save button creates named preset
4. Selecting preset populates all form fields
5. Delete button removes preset after confirmation
6. Overwrite confirmation shown for existing preset names
7. Last used preset loads on application startup
8. Delete button disabled when no presets exist
9. Original IFC transformation functionality still works
</verification>

<success_criteria>
- PRES-01: User can save current transformation values as a named preset
- PRES-02: User can select a preset from dropdown and all form fields populate automatically
- PRES-03: User can delete unwanted presets from the application
- PRES-04: User reopens application and sees the last used preset already loaded
</success_criteria>

<output>
After completion, create `.planning/phases/02-preset-management/02-02-SUMMARY.md`
</output>
